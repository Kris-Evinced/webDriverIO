# Evinced SDK for WebdriverIO

A WebdriverIO SDK to find accessability issues.
## Setup

```bash
npm install @evinced/webdriverio-sdk
```

Add to `wdio.conf.js`:

```js
import Evinced from '@evinced/webdriverio-sdk';

exports.config = {
    // ...
    services: [
        // 'chromedriver',
        // ... other services
        [
            Evinced.WdioService,
            {
                // Optional config
                axeConfig: {
                    rules: {
                        'link-name': { enabled: false }
                    }
                }
            }
        ]
    ]
};
```

## Examples

A minimal working example (add in `tests/specs/evinced.e2e.js`):

```js
it('evAnalyze', async () => {
    await browser.url('https://example.com/');

    const issues = await browser.evAnalyze();

    expect(issues.report).toHaveLength(6);
});
```

Record issues during user interactions:

```js
it('evStart/evStop', async () => {
    await browser.url('https://example.com/');

    await browser.evStart();
    await $(`#button-1`).click();
    await $(`#button-2`).click();
    const issues = await browser.evStop();

    expect(issues.report).toHaveLength(10);
});
```

Creating an HTML report:

```js
it('create HTML report', async () => {
    await browser.url('https://example.com/');

    const issues = await browser.evAnalyze();

    const filePath = path.resolve(__dirname, 'evinced-report.html');
    await browser.evSaveFile(issues, 'html', filePath);
});
```

Validating report by issues filters:

```js
it('Validating test report with skipping CRITICAL severities for issues', async () => {
    await EvincedDemoPage.open()
    const report = await browser.evAnalyze();
    expect(report).toBeEvValid({ ignoreSeverities: ['CRITICAL']})
});
```

## API

### `EvincedConfig` (Evinced.WdioService config)

_Default options_

```js
{
    rootSelector: null, // Set to scan only a subset of the DOM
    filterIssues: null, // Specify which issues should be omitted from the report (IssuesFilter)
    axeConfig: null // Set Axe configuration. https://github.com/dequelabs/axe-core/blob/develop/doc/API.md#api-name-axeconfigure
}
```

### `browser.evAnalyze(options)`

_Default options_

```js
// Same as EvincedConfig
{
    rootSelector: null,
    filterIssues: null,
    axeConfig: null
}
```

_Return value_
```ts
Promise<Issue[]>;
```

_Example:_

```js
const issues = await browser.evAnalyze({
    axeConfig: {
        rules: {
            'link-name': { enabled: false }
        }
    }
});
```

### `browser.evStart(options)`

_Default options_

```js
// Same as EvincedConfig
{
    rootSelector: null,
    filterIssues: null,
    axeConfig: null
}
```

_Side effects_

Watching DOM mutations and recording all accessibility issues until `browser.evStop()` is called.

_Example:_

```js
await browser.evStart({
    axeConfig: {
        rules: {
            'link-name': { enabled: false }
        }
    }
});
await $(`#button-1`).click();
await $(`#button-2`).click();
const issues = await browser.evStop();
```

### `browser.evStop()`

_Return value_
```ts
Promise<Issue[]>;
```

### `browser.evSaveFile(issues, format, destination)`

_Side effects_

Stores a report on the file system of the chosen format.

_Parameters_
```ts
issues: Issue[];
format: 'json' | 'html' | 'sarif';
destination: string;
```

_Example:_

```js
await browser.url('https://example.com/');

const issues = await browser.evAnalyze();

const filePath = path.resolve(__dirname, 'evinced-report.html');
await browser.evSaveFile(issues, 'html', filePath);
```

### `Evinced.inject(browser)`

_Side effects_

Injects Evinced library into the page. Usually this is not needed since calling Evinced commands (`evAnalyze()` for example) will internally inject the lib if it's not already injected.

_Example:_

```js
await Evinced.inject(browser);
```

### Types
```ts
type Issue = {
    id: string;
    index: string;
    signature: string;
    type: {
        id: string;
        name: string;
    };
    severity: {
        id: string;
        name: string;
    };
    summary: string;
    description: string;
    additionalInformation: any;
    duplicates?: string;
    elements: IssueElement[];
    firstSeenTime: number;
    tags: IssueTag[];
    knowledgeBaseLink?: string;
};

type IssueElement = {
    componentId: string;
    domSnippet: string;
    id: string;
    index: string;
    pageUrl: string;
    selector: string;
};

type IssueTag = {
    description: string;
    id: string;
    link: string;
};

type IssuesFilter = {
    exclude?: {
        urls?: (string | RegExp)[]
        selectors?: string[]
        types?: string[] | ValidationType[]
        severities?: IssueSeverity[]
        signatures?: string[]
        tags?: IssueTagId[]
    },
    customFilter?: CustomIssuesFilter
};

interface CustomIssuesFilter {
    (issue: Issue): boolean
}
```
